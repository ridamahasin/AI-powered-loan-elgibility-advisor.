{% extends "base.html" %}
{% block content %}
<div class="card shadow-sm p-4">
  <h3>ðŸ¤– Loan Chatbot</h3>
  <p>Answer the questions one-by-one. The chatbot will predict after the last answer.</p>

  <div id="chat-box" class="border rounded p-3 mb-3" style="height:360px; overflow-y:auto;">
    <div class="bot-message mb-2"><strong>Bot:</strong> {{ first_question }}</div>
  </div>

  <div class="input-group">
    <input id="user-input" type="text" class="form-control" placeholder="Type your answer..." />
    <button id="send-btn" class="btn btn-primary">Send</button>
  </div>

  <div id="final-result" class="mt-3"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById("send-btn").addEventListener("click", sendMessage);
document.getElementById("user-input").addEventListener("keypress", function(e){
  if (e.key === 'Enter') sendMessage();
});

async function sendMessage(){
  const input = document.getElementById("user-input");
  let text = input.value.trim();
  if (!text) return;
  const chatBox = document.getElementById("chat-box");

  // show user message
  const userDiv = document.createElement("div");
  userDiv.className = "user-message mb-2 text-end";
  userDiv.innerHTML = "<strong>You:</strong> " + text;
  chatBox.appendChild(userDiv);
  chatBox.scrollTop = chatBox.scrollHeight;
  input.value = "";

  // send to /chatapi
  const formData = new URLSearchParams();
  formData.append("message", text);
  const res = await fetch("/chatapi", { method: "POST", body: formData });
  const data = await res.json();

  const botDiv = document.createElement("div");
  botDiv.className = "bot-message mb-2";
  botDiv.innerHTML = "<strong>Bot:</strong> " + data.reply.replace(/\n/g, "<br>");
  chatBox.appendChild(botDiv);
  chatBox.scrollTop = chatBox.scrollHeight;

  if (data.end) {
    const final = document.getElementById("final-result");
    final.innerHTML = `<div class="alert ${data.approved ? "alert-success" : "alert-danger"}">${data.reply.replace(/\n/g, "<br>")}</div>`;
    // disable input
    input.disabled = true;
    document.getElementById("send-btn").disabled = true;
  }
}
</script>
{% endblock %}
